<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Food Vocabulary – Coach + Adaptive Video</title>
<style>
:root{
  --bg:#ffffff;--fg:#000;--muted:#475569;--muted2:#64748b;
  --green:#16a34a;--red:#dc2626;--orange:#ea580c;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);
  font:16px/1.6 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
.wrap{max-width:720px;margin:0 auto;padding:40px 16px}
.section{display:none}
.section.active{display:block}

/* Squares with bold black borders (no shadows, no rounded corners) */
.square{background:#fff;border:4px solid #000;border-radius:0}

/* Welcome */
.center-col{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:70vh}
.robot-box{width:120px;height:120px;display:grid;place-items:center;margin:0 auto 12px;border:4px solid #000}
.robot-box img{width:92px;height:92px;object-fit:contain}
.bubble{padding:16px;margin:10px 0;border:4px solid #000;background:#fff}
.btn{border:4px solid #000;background:#000;color:#fff;border-radius:0;cursor:pointer}
.btn-lg{padding:14px 18px;font-weight:900;font-size:16px}
.btn-sm{padding:8px 10px;font-weight:800;font-size:14px}
.btn-row{display:flex;gap:24px;justify-content:center;margin-top:14px}

/* Coach text (larger than options) */
.question{padding:12px 14px;border:4px solid #000;background:#fff;
  font-size:22px;font-weight:800;margin:12px 0 10px;text-align:center}

/* Options: black rectangles, centered, narrower width */
.options{display:grid;gap:12px;justify-items:center}
.choice{display:block;text-align:center;background:#000;color:#fff;border:4px solid #000;border-radius:0;
  padding:14px 12px;opacity:0;transform:translateY(8px);width:100%;max-width:560px}
.choice.show{opacity:1;transform:none;transition:opacity .45s ease, transform .45s ease}
.choice.correct{outline:4px solid var(--green)}
.choice.wrong{outline:4px solid var(--red)}
.choice-title{font-weight:900;margin-bottom:6px;font-size:17px}
.choice-desc{font-size:16px;color:#e5e7eb}

/* Chips and progress dots */
.words-need{display:flex;gap:8px;flex-wrap:wrap}
.pill{display:inline-block;background:#fff;border:4px solid #000;border-radius:0;padding:6px 10px;font-size:13px;color:#111}
.dots{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.dot{width:50px;height:12px;background:#cbd5e1;border:4px solid #000;border-radius:0}
.dot.active{background:var(--orange)}
.dot.done{background:var(--green)}

/* Video */
.aspect{position:relative;padding-top:56.25%;background:#000;overflow:hidden;border:4px solid #000;border-radius:0}
.aspect iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
.spacer{height:28px}
</style>
</head>
<body>
<div class="wrap">

  <!-- Screen 0: Welcome -->
  <div class="section active" id="sec-welcome">
    <div class="center-col">
      <div class="robot-box"><img alt="Coach robot" src="https://raw.githubusercontent.com/ik3057823-ops/images-5/refs/heads/main/robot.png"/></div>
      <div class="bubble" id="welcome-typed"></div>
      <div id="welcome-buttons" class="btn-row" style="visibility:hidden">
        <button class="btn btn-lg" id="btn-skip">SKIP</button>
        <button class="btn btn-lg" id="btn-start">START</button>
      </div>
    </div>
  </div>

  <!-- Screen 1: Coach-guided assessment (no robot here) -->
  <div class="section" id="sec-coach">
    <div class="question" id="coach-bubble"></div>
    <div id="coach-area"></div>
    <div class="square" style="padding:10px;margin-top:8px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span>Progress: <b id="coach-progress">0/5</b></span>
        <button class="btn btn-sm" id="coach-skip">SKIP</button>
      </div>
    </div>
    <div class="spacer"></div>
  </div>

  <!-- Screen 2: Summary -->
  <div class="section" id="sec-summary">
    <div class="question">Your Snapshot</div>
    <div class="square" style="padding:12px;margin-bottom:12px">
      Practice next (1–3): <span id="list-practice" class="words-need" style="margin-left:8px"></span>
    </div>
    <div class="square" style="padding:12px">
      Already strong (4–5): <span id="list-strong" class="words-need" style="margin-left:8px"></span>
    </div>
    <div class="btn-row" style="margin-top:16px">
      <button class="btn btn-sm" id="btn-next-sum">NEXT</button>
    </div>
    <div class="spacer"></div>
  </div>

  <!-- Screen 3: Adaptive video -->
  <div class="section" id="sec-video">
    <div class="question">Targeted Video Practice</div>

    <div class="square" style="padding:12px;margin-bottom:12px">
      Words to watch: <span id="need-words" class="words-need" style="margin-left:8px"></span>
    </div>

    <!-- reserved space where progress text used to be (kept empty intentionally) -->
    <div class="spacer"></div>

    <div style="margin-top:8px" id="video-area"></div>

    <!-- dots under the video with extra bottom padding so they never touch -->
    <div class="dots" id="seg-dots"></div>
    <div class="spacer"></div>

    <div class="btn-row">
      <button class="btn btn-sm" id="btn-focused">FOCUSED</button>
      <button class="btn btn-sm" id="btn-full">FULL VIDEO</button>
    </div>

    <div class="spacer"></div>
  </div>
</div>

<script>
(function(){
  /* ---------- Data ---------- */
  var WORDS=["diet","junk food","whole food","food security","takeaway"];
  var LEVELS=[
    {v:1, title:"Brand-new", desc:"I haven't met this word before."},
    {v:2, title:"Looks familiar", desc:"I've seen it, but I'm not sure."},
    {v:3, title:"I get it when I read", desc:"I can explain the meaning."},
    {v:4, title:"Sentence-ready", desc:"I can use it correctly in my own sentence."},
    {v:5, title:"Confident & flexible", desc:"I can use it with natural collocations/register."}
  ];
  var starts={"diet":46,"junk food":132,"whole food":225,"food security":287,"takeaway":359};
  var VIDEO_ID="LRKlGG0oYKw";

  /* Quality checks */
  function usageQ(word){
    if(word==="diet"){
      return {q:"Pick the sentence that uses “diet” naturally and precisely.",
      opts:[
        "She started a strict diet to reduce sugar and processed food.",
        "I will diet a pizza for my birthday.",
        "The restaurant serves a delicious diet."
      ], a:0, fb:"Use “diet” for a person’s pattern of eating (strict/healthy/balanced)."};
    }
    if(word==="junk food"){
      return {q:"Pick the sentence that best shows the meaning of “junk food”.",
      opts:[
        "During exam week I tend to crave junk food like chips and soda.",
        "We planted junk food in the school garden.",
        "I bought a junk food apple from the market."
      ], a:0, fb:"“Junk food” = highly processed, low-nutrient items (chips, soda, candy)."};
    }
    if(word==="whole food"){
      return {q:"Choose the sentence that reflects the idea of “whole foods”.",
      opts:[
        "Her meals focus on whole foods such as leafy greens, beans, and nuts.",
        "Whole food means food with many artificial additives.",
        "He microwaved whole food noodles with flavor powder."
      ], a:0, fb:"Whole foods are natural/minimally processed items (veg, legumes, nuts)."};
    }
    if(word==="food security"){
      return {q:"Select the sentence that correctly uses “food security”.",
      opts:[
        "Improving storage and supply chains can increase food security in the region.",
        "We ordered food security for lunch yesterday.",
        "Food security is the same as food safety labels on packages."
      ], a:0, fb:"Food security = reliable access to sufficient, safe, nutritious, affordable food."};
    }
    return {q:"Choose the sentence that uses “takeaway” naturally.",
      opts:[
        "We ordered a takeaway because there was no time to cook.",
        "I takeawayed my homework before class.",
        "Takeaway only means eating inside a restaurant."
      ], a:0, fb:"Takeaway = food you order and take away to eat elsewhere."};
  }
  function collocQ(word){
    if(word==="diet"){
      return {q:"Which option shows a natural collocation with “diet”?",
      opts:["be on a balanced diet for three months","order a diet from a café","finish a diet in one evening"], a:0,
      fb:"Common: balanced/strict/healthy diet; be on a diet; stick to a diet."};
    }
    if(word==="junk food"){
      return {q:"Which collocation fits best?",
      opts:["avoid junk food on weekdays","cultivate junk food on a farm","compose junk food in a notebook"], a:0,
      fb:"Typical: avoid, cut down on, crave, snack on junk food."};
    }
    if(word==="whole food"){
      return {q:"Which phrase sounds natural?",
      opts:["eat more whole foods like oats and fresh vegetables","add artificial flavor to make whole foods","whole foods are highly processed snacks"], a:0,
      fb:"Natural: eat whole foods; whole-foods diet; switch to whole foods."};
    }
    if(word==="food security"){
      return {q:"Which verb-noun pair is most appropriate?",
      opts:["ensure food security through stable supply","taste food security at lunch","boil food security in water"], a:0,
      fb:"Typical verbs: ensure, improve, threaten, undermine food security."};
    }
    return {q:"Which collocation with “takeaway” is best?",
      opts:["order a takeaway from the Thai place","grow a takeaway in the garden","grade a takeaway for homework"], a:0,
      fb:"You order/get a takeaway; takeaway menu; leftover takeaway."};
  }

  /* ---------- Typing + pacing ---------- */
  let typingTimers=[];
  function typeText(el, text, speed){
    typingTimers.forEach(clearTimeout); typingTimers=[];
    el.textContent="";
    return new Promise(resolve=>{
      let i=0; const step=()=>{ if(i<text.length){ el.textContent+=text[i++]; typingTimers.push(setTimeout(step, speed)); } else resolve(); };
      step();
    });
  }
  const wait = (ms)=>new Promise(r=>setTimeout(r,ms));

  /* ---------- State ---------- */
  var ratings; try{ratings=JSON.parse(localStorage.getItem("food-coach-ratings-v5"))}catch(e){ratings=null}
  if(!ratings){ratings={}; WORDS.forEach(w=>ratings[w]=0)}
  function save(){ try{localStorage.setItem("food-coach-ratings-v5",JSON.stringify(ratings))}catch(e){} }

  var S={welcome:document.getElementById("sec-welcome"), coach:document.getElementById("sec-coach"), summary:document.getElementById("sec-summary"), video:document.getElementById("sec-video")};
  function show(id){ Object.values(S).forEach(x=>x.classList.remove("active")); S[id].classList.add("active"); }

  /* ---------- Welcome ---------- */
  (async function initWelcome(){
    const tgt=document.getElementById("welcome-typed");
    await wait(250);
    await typeText(
      tgt,
      "Hi! I’m your vocabulary coach. We’ll quickly check how well you know five food words, then build a short video just for you. Click START to take a quick chat-check, or SKIP to jump straight to the full video.",
      28
    );
    await wait(250);
    document.getElementById("welcome-buttons").style.visibility="visible";
  })();
  document.getElementById("btn-start").onclick = () => { show("coach"); startCoach(); };
  document.getElementById("btn-skip").onclick  = () => { renderVideo(true); show("video"); };

  /* ---------- Coach flow ---------- */
  var coachIdx=0;
  var bubble=document.getElementById("coach-bubble");
  var area=document.getElementById("coach-area");
  var prog=document.getElementById("coach-progress");
  document.getElementById("coach-skip").onclick=function(){ renderVideo(true); show("video"); };

  let optionTimers=[];
  function clearOptionTimers(){ optionTimers.forEach(clearTimeout); optionTimers=[]; }

  async function startCoach(){
    coachIdx=0; prog.textContent="0/"+WORDS.length; area.innerHTML="";
    await wait(350);
    await typeText(bubble, "We’ll go word by word. Tell me how well you know each one.", 30);
    await wait(500);
    renderCoach();
  }

  async function renderCoach(){
    clearOptionTimers();
    area.innerHTML="";
    prog.textContent=coachIdx+"/"+WORDS.length;
    if(coachIdx>=WORDS.length){ showSummary(); return; }
    const w=WORDS[coachIdx];
    await wait(350);
    await typeText(bubble, `How well do you know “${w}”?`, 28);
    await wait(450);

    const list=document.createElement("div"); list.className="options"; area.appendChild(list);
    LEVELS.forEach((L, i)=>{
      const b=document.createElement("button");
      b.className="choice"; b.setAttribute("data-level", L.v);
      b.innerHTML = `<div class="choice-title">${L.v} · ${L.title}</div><div class="choice-desc">${L.desc}</div>`;
      b.onclick=()=>handleLevel(w, L.v, list);
      list.appendChild(b);
      optionTimers.push(setTimeout(()=>b.classList.add("show"), 320*i + 260));
    });
  }

  function nextWord(){ coachIdx++; prog.textContent=coachIdx+"/"+WORDS.length; renderCoach(); }

  async function handleLevel(word, level, listEl){
    clearOptionTimers();
    if(level<=3){
      ratings[word]=level; save();
      await wait(250); await typeText(bubble, "Thanks—got it.", 28);
      await wait(400); nextWord(); return;
    }
    // Hide level options first, then ask challenge question
    listEl.innerHTML="";
    await wait(250);
    const isColloc = level===5;
    const Q = isColloc ? collocQ(word) : usageQ(word);
    await typeText(bubble, "Quick check first. "+Q.q, 26);
    await wait(350);

    const list=document.createElement("div"); list.className="options"; area.appendChild(list);
    Q.opts.forEach((opt, i)=>{
      const b=document.createElement("button");
      b.className="choice"; b.innerHTML=`<div class="choice-desc" style="font-size:17px">${opt}</div>`;
      b.onclick=async ()=>{
        [...list.children].forEach(x=>x.disabled=true);
        if(i===Q.a){
          b.classList.add("correct");
          ratings[word]=level; save();
          await wait(250); await typeText(bubble, "Nice use! Moving on.", 26);
          await wait(420); nextWord();
        }else{
          b.classList.add("wrong");
          await wait(250); await typeText(bubble, `We’ll study “${word}” later. Tip: ${Q.fb}`, 26);
          ratings[word]=3; save();
          await wait(450); nextWord();
        }
      };
      list.appendChild(b);
      optionTimers.push(setTimeout(()=>b.classList.add("show"), 320*i + 260));
    });
  }

  /* ---------- Summary ---------- */
  function showSummary(){
    show("summary");
    const practice=document.getElementById("list-practice"); practice.innerHTML="";
    const strong=document.getElementById("list-strong"); strong.innerHTML="";
    WORDS.forEach(w=>{
      const lvl=ratings[w]||1;
      const chip=document.createElement("span");
      chip.className="pill"; chip.textContent=`${w} · ${lvl}`;
      if(lvl>=4){ strong.appendChild(chip); } else { practice.appendChild(chip); }
    });
  }
  document.getElementById("btn-next-sum").onclick=function(){ renderVideo(false); show("video"); };

  /* ---------- Video ---------- */
  function buildEmbed(start,end,controls,autoplay){
    const p=new URLSearchParams({rel:"0",modestbranding:"1",controls:String(controls?1:0),disablekb:"1",fs:"0"});
    if(typeof start!=="undefined") p.set("start",String(start));
    if(typeof end!=="undefined") p.set("end",String(end));
    p.set("autoplay",autoplay?"1":"0");
    return `https://www.youtube-nocookie.com/embed/${VIDEO_ID}?${p.toString()}`;
  }
  function fmt(t){const m=('0'+Math.floor(t/60)).slice(-2);const s=('0'+(t%60)).slice(-2);return `${m}:${s}`;}

  function renderVideo(startFullImmediately){
    const ordered=["diet","junk food","whole food","food security","takeaway"];
    const segs=ordered.map((w,i)=>({word:w,start:starts[w],end:i<ordered.length-1?starts[ordered[i+1]]-1:undefined,level:ratings[w]||0}));
    const needed=segs.filter(s=>s.level>=1&&s.level<=3);

    const needWords=document.getElementById("need-words"); needWords.innerHTML="";
    needed.forEach(s=>{const e=document.createElement("span"); e.className="pill"; e.textContent=s.word; needWords.appendChild(e);});

    const area=document.getElementById("video-area");
    const dotsHost=document.getElementById("seg-dots"); dotsHost.innerHTML="";
    let mode = startFullImmediately ? 'full' : 'none';
    let idx=0, started=new Array(needed.length).fill(false); // turn green when started

    // Build static dots once
    needed.forEach((s,i)=>{const d=document.createElement('button'); d.className='dot'; dotsHost.appendChild(d);});

    let ytReady=false, player=null;
    function loadYT(){ if(window.YT&&window.YT.Player){onReady();return} const tag=document.createElement('script'); tag.src='https://www.youtube.com/iframe_api'; document.body.appendChild(tag); window.onYouTubeIframeAPIReady=onReady; }
    function onReady(){ ytReady=true; if(mode==='focused') renderPlayer(); }

    function markDots(){
      const dots=[...dotsHost.children];
      dots.forEach((d,i)=>{ d.classList.remove('active'); if(started[i]) d.classList.add('done'); });
      if(dots[idx]) dots[idx].classList.add('active');
    }

    function mountAPI(start,end){
      area.innerHTML='';
      const holder=document.createElement('div'); holder.className='aspect';
      const inner=document.createElement('div'); inner.id='yt-holder'; holder.appendChild(inner);
      area.appendChild(holder);
      markDots();

      player=new YT.Player('yt-holder',{
        videoId:VIDEO_ID,
        playerVars:{start:start,end:end,controls:0,rel:0,fs:0,modestbranding:1,disablekb:1},
        events:{
          onReady:(e)=>{ e.target.playVideo(); },
          onStateChange:(e)=>{
            if(e.data===YT.PlayerState.PLAYING){
              if(!started[idx]){ started[idx]=true; markDots(); } // turn green once started
            }
            if(e.data===YT.PlayerState.ENDED){
              if(idx<needed.length-1){ idx++; renderPlayer(); }
            }
          }
        }
      });
    }

    function renderPlayer(){
      if(mode==='full'){
        area.innerHTML='';
        const frame=document.createElement('div'); frame.className='aspect';
        frame.innerHTML=`<iframe src="${buildEmbed(undefined,undefined,false,false)}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>`;
        area.appendChild(frame);
      } else if(mode==='focused'){
        if(!needed.length){ area.innerHTML='<div class="square" style="padding:12px">Nice! You rated everything 4–5. Switch to FULL VIDEO to watch without skips.</div>'; return; }
        const cur=needed[idx]; markDots();
        if(ytReady){ mountAPI(cur.start,cur.end); } else { loadYT(); }
      } else {
        area.innerHTML='<div class="square" style="padding:12px;text-align:center">Choose <b>FOCUSED</b> to watch only the parts for your 1–3 words, or <b>FULL VIDEO</b> to watch everything.</div>';
      }
    }

    document.getElementById('btn-full').onclick=()=>{ mode='full'; renderPlayer(); };
    document.getElementById('btn-focused').onclick=()=>{ mode='focused'; renderPlayer(); };

    if(startFullImmediately){ renderPlayer(); }
  }

})();
</script>
</body>
</html>
