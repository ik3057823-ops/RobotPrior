<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Food Vocabulary – Coach + Adaptive Video</title>
<style>
:root{
  --bg:#ffffff;--fg:#0f172a;--muted:#475569;--muted2:#64748b;--accent:#0f172a;
  --pill:#f1f5f9;--green:#16a34a;--red:#dc2626;--orange:#ea580c;--dark:#000000;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
.wrap{max-width:700px;margin:0 auto;padding:48px 16px}
.h1{font-size:20px;font-weight:700;margin:0 0 10px}
.small{font-size:12px;color:var(--muted2)}
.section{display:none}
.section.active{display:block}

/* Strict square, bold-line style (no shadows anywhere) */
.square{background:#fff;border:4px solid #000;border-radius:0}
.robot-box{width:120px;height:120px;display:grid;place-items:center;margin:0 auto 12px;border:4px solid #000}
.robot-box img{width:92px;height:92px;object-fit:contain}

/* Bubble + question text */
.bubble{padding:16px;margin:10px 0 10px;border:4px solid #000;border-radius:0;background:#fff}
.question{padding:12px 14px;border:4px solid #000;background:#fff;font-size:20px;font-weight:800;margin:12px 0 10px;text-align:center}

/* Buttons: square, black, no shadow */
.btn{border:4px solid #000;background:#000;color:#fff;border-radius:0;padding:16px 18px;font-weight:900;cursor:pointer;font-size:16px}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn-row{display:flex;gap:24px;justify-content:center;margin-top:14px}

/* Choices: black rectangles like the screenshot */
.grid{display:grid;gap:12px}
.choice{display:block;width:100%;text-align:center;background:#000;color:#fff;border:4px solid #000;border-radius:0;padding:16px 12px;opacity:0;transform:translateY(8px)}
.choice.show{opacity:1;transform:none;transition:opacity .45s ease, transform .45s ease}
.choice.correct{outline:4px solid var(--green)}
.choice.wrong{outline:4px solid var(--red)}
.choice-title{font-weight:900;margin-bottom:6px;font-size:18px}
.choice-desc{font-size:16px;color:#e5e7eb}

/* Progress + chips */
.progress{height:8px;background:#eef2f7;overflow:hidden;border:4px solid #000;border-radius:0}
.progress>i{display:block;height:100%;background:var(--green);width:0}
.words-need{display:flex;gap:8px;flex-wrap:wrap}
.pill{display:inline-block;background:#fff;border:4px solid #000;border-radius:0;padding:6px 10px;font-size:13px;color:#111}
.hstack{display:flex;justify-content:space-between;align-items:center}
.row{display:flex;gap:10px;align-items:center}
.aspect{position:relative;padding-top:56.25%;background:#000;overflow:hidden;border:4px solid #000;border-radius:0}
.aspect iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
.dots{display:flex;gap:10px;flex-wrap:wrap}
.dot{width:50px;height:12px;background:#cbd5e1;border:4px solid #000;border-radius:0}
.dot.active{background:var(--orange)}
.dot.done{background:var(--green)}
.spacer{height:24px}

/* Centering for welcome */
.center-col{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:70vh}
</style>
</head>
<body>
<div class="wrap">

  <!-- Screen 0: Welcome (centered, outline first then typing) -->
  <div class="section active" id="sec-welcome">
    <div class="center-col">
      <div class="robot-box"><img alt="Coach robot" src="https://raw.githubusercontent.com/ik3057823-ops/images-5/refs/heads/main/robot.png"/></div>
      <div class="bubble" id="welcome-typed"></div>
      <div class="question" id="welcome-instr" style="display:none">
        Click START to take a quick chat-check, or SKIP to jump straight to the full video.
      </div>
      <div id="welcome-buttons" class="btn-row" style="visibility:hidden">
        <button class="btn" id="btn-skip">SKIP</button>
        <button class="btn" id="btn-start">START</button>
      </div>
    </div>
  </div>

  <!-- Screen 1: Coach-guided assessment -->
  <div class="section" id="sec-coach">
    <div class="robot-box" style="margin-bottom:6px"><img alt="Coach robot" src="https://raw.githubusercontent.com/ik3057823-ops/images-5/refs/heads/main/robot.png"/></div>
    <div class="bubble" id="coach-bubble"></div>
    <div id="coach-area"></div>
    <div class="hstack" style="margin-top:8px">
      <div class="small">Progress: <span id="coach-progress">0/5</span></div>
      <button class="btn" id="coach-skip">Skip word</button>
    </div>
    <div class="spacer"></div>
  </div>

  <!-- Screen 2: Summary (clear groups) -->
  <div class="section" id="sec-summary">
    <div class="h1">Your Snapshot</div>
    <div class="small" id="summary-sub"></div>

    <div class="grid" style="margin-top:12px">
      <div class="square" id="card-practice" style="padding:12px">
        <div class="h1" style="font-size:18px">Practice next (1–3)</div>
        <div id="list-practice" class="words-need"></div>
      </div>
      <div class="square" id="card-strong" style="padding:12px">
        <div class="h1" style="font-size:18px">Already strong (4–5)</div>
        <div id="list-strong" class="words-need"></div>
      </div>
    </div>

    <div class="hstack" style="margin-top:16px">
      <button class="btn" id="btn-back-sum">Back</button>
      <button class="btn" id="btn-next-sum">Next</button>
    </div>
    <div class="spacer"></div>
  </div>

  <!-- Screen 3: Adaptive video -->
  <div class="section" id="sec-video">
    <div class="h1">Targeted Video Practice</div>
    <div class="small">We’ll play only the parts for words you rated 1–3. You can watch the full video too.</div>

    <div class="spacer"></div>
    <div class="small" style="margin-bottom:6px"><b>Words to watch</b></div>
    <div class="words-need" id="need-words"></div>

    <div style="margin-top:12px">
      <div class="hstack small"><span id="seg-count">Segments completed: 0/0</span><span id="seg-pct">0%</span></div>
      <div class="progress" style="margin-top:6px"><i id="seg-bar"></i></div>
    </div>

    <div class="hstack" style="margin-top:12px">
      <div class="row">
        <button class="btn" id="btn-focused">Focused</button>
        <button class="btn" id="btn-full">Full video</button>
      </div>
      <div class="small">Mode: <b id="mode-label">Choose a mode</b></div>
    </div>

    <div style="margin-top:12px" id="video-area"></div>

    <div class="hstack" style="margin-top:14px">
      <button class="btn" id="btn-back-vid">Back</button>
      <div class="small">Tip: Try Focused first, then Full.</div>
    </div>
    <div class="spacer"></div>
  </div>
</div>

<script>
(function(){
  /* ---------- Data ---------- */
  var WORDS=["diet","junk food","whole food","food security","takeaway"];
  var LEVELS=[
    {v:1, title:"Brand-new", desc:"I haven't met this word before."},
    {v:2, title:"Looks familiar", desc:"I've seen it, but I'm not sure."},
    {v:3, title:"I get it when I read", desc:"I can explain the meaning."},
    {v:4, title:"Sentence-ready", desc:"I can use it correctly in my own sentence."},
    {v:5, title:"Confident & flexible", desc:"I can use it with natural collocations/register."}
  ];
  var starts={"diet":46,"junk food":132,"whole food":225,"food security":287,"takeaway":359};
  var VIDEO_ID="LRKlGG0oYKw";

  /* Quality checks */
  function usageQ(word){
    if(word==="diet"){
      return {q:"Pick the sentence that uses “diet” naturally and precisely.",
      opts:[
        "She started a strict diet to reduce sugar and processed food.",
        "I will diet a pizza for my birthday.",
        "The restaurant serves a delicious diet."
      ], a:0, fb:"Use “diet” for a person’s pattern of eating (strict/healthy/balanced)."};
    }
    if(word==="junk food"){
      return {q:"Pick the sentence that best shows the meaning of “junk food”.",
      opts:[
        "During exam week I tend to crave junk food like chips and soda.",
        "We planted junk food in the school garden.",
        "I bought a junk food apple from the market."
      ], a:0, fb:"“Junk food” = highly processed, low-nutrient items (chips, soda, candy)."};
    }
    if(word==="whole food"){
      return {q:"Choose the sentence that reflects the idea of “whole foods”.",
      opts:[
        "Her meals focus on whole foods such as leafy greens, beans, and nuts.",
        "Whole food means food with many artificial additives.",
        "He microwaved whole food noodles with flavor powder."
      ], a:0, fb:"Whole foods are natural/minimally processed items (veg, legumes, nuts)."};
    }
    if(word==="food security"){
      return {q:"Select the sentence that correctly uses “food security”.",
      opts:[
        "Improving storage and supply chains can increase food security in the region.",
        "We ordered food security for lunch yesterday.",
        "Food security is the same as food safety labels on packages."
      ], a:0, fb:"Food security = reliable access to sufficient, safe, nutritious, affordable food."};
    }
    return {q:"Choose the sentence that uses “takeaway” naturally.",
      opts:[
        "We ordered a takeaway because there was no time to cook.",
        "I takeawayed my homework before class.",
        "Takeaway only means eating inside a restaurant."
      ], a:0, fb:"Takeaway = food you order and take away to eat elsewhere."};
  }
  function collocQ(word){
    if(word==="diet"){
      return {q:"Which option shows a natural collocation with “diet”?",
      opts:["be on a balanced diet for three months","order a diet from a café","finish a diet in one evening"], a:0,
      fb:"Common: balanced/strict/healthy diet; be on a diet; stick to a diet."};
    }
    if(word==="junk food"){
      return {q:"Which collocation fits best?",
      opts:["avoid junk food on weekdays","cultivate junk food on a farm","compose junk food in a notebook"], a:0,
      fb:"Typical: avoid, cut down on, crave, snack on junk food."};
    }
    if(word==="whole food"){
      return {q:"Which phrase sounds natural?",
      opts:["eat more whole foods like oats and fresh vegetables","add artificial flavor to make whole foods","whole foods are highly processed snacks"], a:0,
      fb:"Natural: eat whole foods; whole-foods diet; switch to whole foods."};
    }
    if(word==="food security"){
      return {q:"Which verb-noun pair is most appropriate?",
      opts:["ensure food security through stable supply","taste food security at lunch","boil food security in water"], a:0,
      fb:"Typical verbs: ensure, improve, threaten, undermine food security."};
    }
    return {q:"Which collocation with “takeaway” is best?",
      opts:["order a takeaway from the Thai place","grow a takeaway in the garden","grade a takeaway for homework"], a:0,
      fb:"You order/get a takeaway; takeaway menu; leftover takeaway."};
  }

  /* ---------- Typing utility with pacing ---------- */
  let typingTimers=[];
  function typeText(el, text, speed){
    typingTimers.forEach(clearTimeout); typingTimers=[];
    el.textContent="";
    return new Promise(resolve=>{
      let i=0;
      const step=()=>{ if(i<text.length){ el.textContent+=text[i++]; typingTimers.push(setTimeout(step, speed)); } else resolve(); };
      step();
    });
  }
  function wait(ms){return new Promise(r=>setTimeout(r,ms))}

  /* ---------- State ---------- */
  var ratings; try{ratings=JSON.parse(localStorage.getItem("food-coach-ratings-v4"))}catch(e){ratings=null}
  if(!ratings){ratings={}; WORDS.forEach(w=>ratings[w]=0)}
  function save(){ try{localStorage.setItem("food-coach-ratings-v4",JSON.stringify(ratings))}catch(e){} }

  var S={welcome:document.getElementById("sec-welcome"), coach:document.getElementById("sec-coach"), summary:document.getElementById("sec-summary"), video:document.getElementById("sec-video")};
  function show(id){ Object.values(S).forEach(x=>x.classList.remove("active")); S[id].classList.add("active"); }

  /* ---------- Welcome ---------- */
  (async function initWelcome(){
    // Show empty square first, then type into it
    const wtxt=document.getElementById("welcome-typed");
    await wait(350);
    await typeText(wtxt,"Hi! I’m your vocabulary coach. I’ll quickly check how well you know five food words, then build a short video just for you.",34);
    await wait(450);
    document.getElementById("welcome-instr").style.display="block";
    await wait(250);
    document.getElementById("welcome-buttons").style.visibility="visible";
  })();
  document.getElementById("btn-start").onclick = () => { show("coach"); startCoach(); };
  document.getElementById("btn-skip").onclick  = () => { renderVideo(true); show("video"); };

  /* ---------- Coach flow ---------- */
  var coachIdx=0;
  var bubble=document.getElementById("coach-bubble");
  var area=document.getElementById("coach-area");
  var prog=document.getElementById("coach-progress");
  document.getElementById("coach-skip").onclick=function(){nextWord()};

  let optionTimers=[];
  function clearOptionTimers(){ optionTimers.forEach(clearTimeout); optionTimers=[]; }

  async function startCoach(){
    coachIdx=0; prog.textContent="0/"+WORDS.length; area.innerHTML="";
    await wait(300);
    await typeText(bubble, "We’ll go word by word. Tell me how well you know each one.", 34);
    await wait(500);
    renderCoach();
  }

  async function renderCoach(){
    clearOptionTimers();
    area.innerHTML="";
    prog.textContent=coachIdx+"/"+WORDS.length;
    if(coachIdx>=WORDS.length){ showSummary(); return; }
    const w=WORDS[coachIdx];
    await wait(300);
    // Show square first, then question typing (bigger font)
    bubble.innerHTML="";
    bubble.style.minHeight="0";
    await typeText(bubble, `How well do you know “${w}”?`, 32);
    await wait(450);

    const list=document.createElement("div"); list.className="grid"; area.appendChild(list);
    LEVELS.forEach((L, i)=>{
      const b=document.createElement("button");
      b.className="choice"; b.setAttribute("data-level", L.v);
      b.innerHTML = `<div class="choice-title">${L.v} · ${L.title}</div><div class="choice-desc">${L.desc}</div>`;
      b.onclick=()=>handleLevel(w, L.v);
      list.appendChild(b);
      optionTimers.push(setTimeout(()=>b.classList.add("show"), 320*i + 220)); // slower, spaced
    });
  }

  function nextWord(){ coachIdx++; prog.textContent=coachIdx+"/"+WORDS.length; renderCoach(); }

  async function handleLevel(word, level){
    clearOptionTimers();
    // levels 1–3: accept directly
    if(level<=3){ ratings[word]=level; save(); await wait(250); await typeText(bubble, "Thanks—got it.", 32); await wait(400); nextWord(); return; }
    // levels 4–5: challenge
    const isColloc = level===5;
    const Q = isColloc ? collocQ(word) : usageQ(word);
    await wait(250);
    bubble.innerHTML="";
    await typeText(bubble, "Quick check first. "+Q.q, 30);
    await wait(350);
    area.innerHTML="";
    const list=document.createElement("div"); list.className="grid"; area.appendChild(list);

    Q.opts.forEach((opt, i)=>{
      const b=document.createElement("button");
      b.className="choice"; b.innerHTML=`<div class="choice-desc" style="font-size:18px">${opt}</div>`;
      b.onclick=async ()=>{
        [...list.children].forEach(x=>x.disabled=true);
        if(i===Q.a){
          b.classList.add("correct");
          ratings[word]=level; save();
          await wait(250); await typeText(bubble, "Nice use! Moving on.", 30);
          await wait(400); nextWord();
        }else{
          b.classList.add("wrong");
          await wait(250); await typeText(bubble, `We’ll study “${word}” later. Tip: ${Q.fb}`, 30);
          ratings[word]=3; save();
          await wait(450); nextWord();
        }
      };
      list.appendChild(b);
      optionTimers.push(setTimeout(()=>b.classList.add("show"), 320*i + 220));
    });
  }

  /* ---------- Summary ---------- */
  function showSummary(){
    show("summary");
    document.getElementById("summary-sub").textContent="Practice targets on the left (1–3). Strong words on the right (4–5).";
    const practice=document.getElementById("list-practice"); practice.innerHTML="";
    const strong=document.getElementById("list-strong"); strong.innerHTML="";

    WORDS.forEach(w=>{
      const lvl=ratings[w]||1;
      const chip=document.createElement("span");
      chip.className="pill";
      chip.textContent=`${w} · ${lvl}`;
      if(lvl>=4){ chip.style.background="#fff"; chip.style.color="#000"; strong.appendChild(chip); }
      else { practice.appendChild(chip); }
    });
  }
  document.getElementById("btn-back-sum").onclick=function(){ show("coach"); startCoach(); }
  document.getElementById("btn-next-sum").onclick=function(){ renderVideo(false); show("video"); }

  /* ---------- Video ---------- */
  function buildEmbed(start,end,controls,autoplay){
    const p=new URLSearchParams({rel:"0",modestbranding:"1",controls:String(controls?1:0),disablekb:"1",fs:"0"});
    if(typeof start!=="undefined") p.set("start",String(start));
    if(typeof end!=="undefined") p.set("end",String(end));
    p.set("autoplay",autoplay?"1":"0");
    return `https://www.youtube-nocookie.com/embed/${VIDEO_ID}?${p.toString()}`;
  }
  function fmt(t){const m=('0'+Math.floor(t/60)).slice(-2);const s=('0'+(t%60)).slice(-2);return `${m}:${s}`;}

  function renderVideo(startFullImmediately){
    const ordered=["diet","junk food","whole food","food security","takeaway"];
    const segs=ordered.map((w,i)=>({word:w,start:starts[w],end:i<ordered.length-1?starts[ordered[i+1]]-1:undefined,level:ratings[w]||0}));
    const needed=segs.filter(s=>s.level>=1&&s.level<=3);

    const needWords=document.getElementById("need-words"); needWords.innerHTML="";
    needed.forEach(s=>{const e=document.createElement("span"); e.className="pill"; e.textContent=s.word; needWords.appendChild(e);});

    const area=document.getElementById("video-area");
    const segCount=document.getElementById("seg-count");
    const segPct=document.getElementById("seg-pct");
    const segBar=document.getElementById("seg-bar");
    const modeLabel=document.getElementById("mode-label");

    let mode = startFullImmediately ? 'full' : 'none';
    let idx=0, completed=new Array(needed.length).fill(false);
    function updateProg(){const total=needed.length, done=completed.filter(Boolean).length, pct=total?Math.round(done/total*100):0; segCount.textContent=`Segments completed: ${done}/${total}`; segPct.textContent=`${pct}%`; if(segBar) segBar.style.width=`${pct}%`; }
    updateProg();

    let ytReady=false, player=null;
    function loadYT(){ if(window.YT&&window.YT.Player){onReady();return} const tag=document.createElement('script'); tag.src='https://www.youtube.com/iframe_api'; document.body.appendChild(tag); window.onYouTubeIframeAPIReady=onReady; }
    function onReady(){ ytReady=true; if(mode==='focused') renderPlayer(); }

    function mountAPI(start,end){
      area.innerHTML='';
      const meta=document.createElement('div'); meta.className='small'; meta.innerHTML=`<b>Segment ${idx+1} of ${needed.length}</b> — ${needed[idx].word}`;
      const holder=document.createElement('div'); holder.className='aspect'; const inner=document.createElement('div'); inner.id='yt-holder'; holder.appendChild(inner);

      const dots=document.createElement('div'); dots.className='dots';
      needed.forEach((s,i)=>{const d=document.createElement('button'); d.className='dot '+(i===idx?'active':(completed[i]?'done':'')); d.onclick=()=>{idx=i; renderPlayer()}; dots.appendChild(d);});
      const timing=document.createElement('div'); timing.className='small'; timing.style.margin='6px 0'; timing.textContent=`Starts at ${fmt(start)}${typeof end!=='undefined'?' · ends at '+fmt(end):''}`;

      const controls=document.createElement('div'); controls.className='hstack';
      const btns=document.createElement('div'); btns.className='row';
      const b1=document.createElement('button'); b1.className='btn'; b1.textContent='Prev'; b1.disabled=idx===0; b1.onclick=()=>{idx=Math.max(0,idx-1); renderPlayer();};
      const b2=document.createElement('button'); b2.className='btn'; b2.textContent='Rewatch'; b2.onclick=()=>{ if(player){ player.seekTo(start,true); player.playVideo(); } };
      const b3=document.createElement('button'); b3.className='btn'; b3.textContent='Next'; b3.disabled=idx===needed.length-1; b3.onclick=()=>{ idx=Math.min(needed.length-1,idx+1); renderPlayer(); };
      btns.appendChild(b1); btns.appendChild(b2); btns.appendChild(b3); controls.appendChild(document.createElement('span')); controls.appendChild(btns);

      area.appendChild(meta); area.appendChild(holder); area.appendChild(dots); area.appendChild(timing); area.appendChild(controls);

      player=new YT.Player('yt-holder',{
        videoId:VIDEO_ID,
        playerVars:{start:start,end:end,controls:0,rel:0,fs:0,modestbranding:1,disablekb:1},
        events:{
          onReady:(e)=>{ e.target.playVideo(); },
          onStateChange:(e)=>{
            if(e.data===YT.PlayerState.ENDED){
              completed[idx]=true; updateProg();
              if(idx<needed.length-1){ idx++; renderPlayer(); }
            }
          }
        }
      });
    }

    function renderPlayer(){
      if(mode==='full'){
        modeLabel.textContent='Full video';
        area.innerHTML='';
        const frame=document.createElement('div'); frame.className='aspect';
        frame.innerHTML=`<iframe src="${buildEmbed(undefined,undefined,false,false)}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>`;
        area.appendChild(frame);
      } else if(mode==='focused'){
        modeLabel.textContent='Focused';
        if(!needed.length){ area.innerHTML='<div class="small">Nice! You rated everything 4–5. Switch to Full video to watch without skips.</div>'; return; }
        const cur=needed[idx];
        if(ytReady){ mountAPI(cur.start,cur.end); } else { loadYT(); }
      } else {
        modeLabel.textContent='Choose a mode';
        area.innerHTML='<div class="small">Choose <b>Focused</b> to watch only the parts for your 1–3 words, or <b>Full video</b> to watch everything.</div>';
      }
    }

    document.getElementById('btn-full').onclick=()=>{ mode='full'; renderPlayer(); };
    document.getElementById('btn-focused').onclick=()=>{ mode='focused'; renderPlayer(); };

    if(startFullImmediately){ renderPlayer(); }
  }

  document.getElementById("btn-back-vid").onclick=function(){ show("summary"); }

})();
</script>
</body>
</html>
